<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Uspeak - Talk to kid</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --brand:#002F87;
      --accent:#4CAF50;
      --chip-bg:#f9f9f9;
      --chip-bd:#ddd;
      --text:#333;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Segoe UI',sans-serif;
      background:linear-gradient(135deg,var(--brand),#6A75B3);
      min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center;padding:20px;color:var(--text);
    }
    .container{
      background:white;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);
      padding:24px;max-width:820px;width:100%;text-align:center;
    }
    .header h1{font-size:1.6rem;color:#d32f2f;margin:0 0 6px}
    .header p{font-size:.95rem;color:#666;margin:0 0 14px}

    /* Vùng checkbox gọn + thẳng hàng */
    .topics-wrap{max-width:820px;margin:0 auto 12px;padding:0 2px}
    #topicOptions{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:6px;justify-items:start;align-items:center;font-size:13px;
      max-height:170px;overflow:auto;padding:6px;border-radius:10px;background:#fafafa;border:1px solid #eee;
    }
    .topic-option{
      background:var(--chip-bg);padding:4px 8px;border-radius:8px;display:flex;align-items:center;gap:6px;border:1px solid var(--chip-bd);
      white-space:nowrap;min-height:28px
    }
    .topic-option input[type="checkbox"]{transform:scale(.9);cursor:pointer}
    .topic-option label{cursor:pointer}

    .question{font-size:2rem;font-weight:700;margin:18px 0;color:var(--text)}
    .answer{font-size:1.25rem;color:#2e7d32;font-weight:700;display:none;margin-bottom:10px}
    .answer.show{display:block}

    .btn{padding:12px 20px;border:none;border-radius:20px;margin:8px;font-weight:700;font-size:1rem;cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-secondary{background:var(--accent);color:#fff}

    #progress{font-weight:700;margin-top:6px}

    @media (max-width:480px){
      .container{padding:18px}
      #topicOptions{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));font-size:12px;max-height:160px}
      .question{font-size:1.6rem}
      .answer{font-size:1.05rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>USPEAK-TALK TO KID</h1>
      <p>Dữ liệu sẽ được update mới sau từng buổi học.</p>
    </div>

    <div class="topics-wrap">
      <div id="topicOptions" class="topic-options">Đang tải dữ liệu...</div>
    </div>

    <div class="question" id="question">Chưa có dữ liệu.</div>
    <div class="answer" id="answer"></div>
    <div id="progress">0/0 câu</div>

    <button class="btn btn-primary" id="showAnswerBtn" disabled><i class="fa fa-eye"></i> Xem kết quả</button>
    <button class="btn btn-secondary" id="nextBtn" disabled><i class="fa fa-dice"></i> Câu tiếp theo</button>
  </div>

  <script>
    let allData = [], filteredData = [], usedIndexes = [], currentIndex = -1;

    /* --------- Đường dẫn file Excel cho GitHub Pages (subpath) --------- */
    const basePath = location.pathname.replace(/[^/]+$/,'');
    const possibleFiles = [
      `${basePath}Uspeak_TTK.xlsx`,
      `${basePath}data.xlsx`,
      'Uspeak_TTK.xlsx', // fallback
      'data.xlsx'        // fallback
    ];

    /* --------- Load Excel: đọc tất cả sheet + tắt cache --------- */
    async function tryLoadExcelFiles() {
      const errors = [];
      for (const url of possibleFiles) {
        try {
          const res = await fetch(encodeURI(url), { cache: 'no-store' });
          if (!res.ok) { errors.push(`${url} -> HTTP ${res.status}`); continue; }

          const buffer = await res.arrayBuffer();
          const workbook = XLSX.read(buffer, { type: "array" });

          // Gộp tất cả sheet
          let merged = [];
          for (const sName of workbook.SheetNames) {
            const sheet = workbook.Sheets[sName];
            if (!sheet) continue;
            const json = XLSX.utils.sheet_to_json(sheet);
            if (Array.isArray(json) && json.length) merged = merged.concat(json);
          }

          // Đọc linh hoạt tên cột
          const pick = (row, keys) => {
            for (const k of keys) {
              if (row[k] !== undefined && row[k] !== null && `${row[k]}`.trim() !== '') return `${row[k]}`;
            }
            const norm = Object.fromEntries(Object.keys(row).map(k => [k.toLowerCase().replace(/\s|_/g,''), k]));
            for (const k of keys) {
              const kk = k.toLowerCase().replace(/\s|_/g,'');
              const real = norm[kk];
              if (real !== undefined) {
                const v = row[real];
                if (v !== undefined && v !== null && `${v}`.trim() !== '') return `${v}`;
              }
            }
            return '';
          };

          allData = merged.map(row => ({
            topic: pick(row, ["CHU_DE","CHU DE","CHUDE","Chu_de","chu_de","TOPIC","Chủ đề","Chude"]).trim(),
            vi:    pick(row, ["DE_BAI","DE BAI","DEBAI","De_bai","CÂU HỎI","VI","Question"]).trim(),
            en:    pick(row, ["DAP_AN","DAP AN","DAPAN","Dap_an","TRẢ LỜI","EN","Answer"]).trim()
          })).filter(item => item.topic && item.vi && item.en);

          createTopicCheckboxes();
          return; // OK
        } catch (err) {
          errors.push(`${url} -> ${err && err.message ? err.message : 'fetch/read failed'}`);
        }
      }
      document.getElementById("question").innerText = "Không tìm thấy file Excel phù hợp!\n" + errors.join("\n");
    }

    /* --------- Sắp xếp số tự nhiên cho chủ đề (1,2,3…10,11) --------- */
    function naturalTopicSort(a, b){
      const mA = a.match(/^\s*(\d+)/), mB = b.match(/^\s*(\d+)/);
      if (mA && mB) {
        const nA = +mA[1], nB = +mB[1];
        if (nA !== nB) return nA - nB;
        const restA = a.slice(mA[0].length).trim();
        const restB = b.slice(mB[0].length).trim();
        return restA.localeCompare(restB,'vi');
      }
      if (mA) return -1;
      if (mB) return 1;
      return a.localeCompare(b,'vi');
    }

    function createTopicCheckboxes() {
      const container = document.getElementById("topicOptions");
      const topics = [...new Set(allData.map(d => d.topic))].sort(naturalTopicSort);
      container.innerHTML = '';

      // Tất cả
      const allBox = document.createElement("div");
      allBox.className = "topic-option";
      allBox.innerHTML = `<input type="checkbox" id="allTopics" checked> <label for="allTopics"><strong>Tất cả</strong></label>`;
      container.appendChild(allBox);

      // Chủ đề
      topics.forEach(topic => {
        const div = document.createElement("div");
        div.className = "topic-option";
        const safeId = `t_${btoa(topic).replace(/[^a-z0-9]/gi,'')}`;
        div.innerHTML = `<input type="checkbox" class="topicCheckbox" id="${safeId}" value="${topic}"> <label for="${safeId}">${topic}</label>`;
        container.appendChild(div);
      });

      container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", handleTopicFilter);
      });

      handleTopicFilter();
    }

    function handleTopicFilter() {
      const checkAll = document.getElementById("allTopics").checked;
      const checkboxes = document.querySelectorAll(".topicCheckbox");

      if (checkAll) {
        filteredData = [...allData];
        checkboxes.forEach(cb => cb.checked = false);
      } else {
        const selectedTopics = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
        filteredData = allData.filter(item => selectedTopics.includes(item.topic));
      }

      usedIndexes = [];
      document.getElementById("progress").innerText = `0/${filteredData.length} câu`;
      document.getElementById("nextBtn").disabled = filteredData.length === 0;
      document.getElementById("showAnswerBtn").disabled = true;

      if (filteredData.length > 0) nextQuestion();
      else {
        document.getElementById("question").innerText = "Vui lòng chọn ít nhất một chủ đề!";
        document.getElementById("answer").innerText = "";
      }
    }

    function nextQuestion() {
      if (filteredData.length === 0) return;
      if (usedIndexes.length === filteredData.length) usedIndexes = [];

      const available = filteredData.map((_, i) => i).filter(i => !usedIndexes.includes(i));
      currentIndex = available[Math.floor(Math.random() * available.length)];
      usedIndexes.push(currentIndex);

      const q = filteredData[currentIndex];
      document.getElementById("question").innerText = q.vi;
      document.getElementById("answer").innerText = q.en;
      document.getElementById("answer").classList.remove("show");
      document.getElementById("showAnswerBtn").disabled = false;

      document.getElementById("progress").innerText = `${usedIndexes.length}/${filteredData.length} câu`;
    }

    function showAnswer() {
      const text = document.getElementById("answer").innerText;
      document.getElementById("answer").classList.add("show");

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US";
      const voices = speechSynthesis.getVoices();
      const preferred = voices.find(v => v.lang === 'en-US' && v.name.toLowerCase().includes('google'));
      if (preferred) utterance.voice = preferred;
      speechSynthesis.speak(utterance);
    }

    document.getElementById("nextBtn").addEventListener("click", nextQuestion);
    document.getElementById("showAnswerBtn").addEventListener("click", showAnswer);

    tryLoadExcelFiles();
  </script>
</body>
</html>
